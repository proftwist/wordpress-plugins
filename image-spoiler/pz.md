# Плагин Image Spoiler - Спойлер для изображений

## Описание

Плагин **Image Spoiler** расширяет стандартный блок "Изображение" (Image) в редакторе Gutenberg, добавляя функцию спойлера. Эта функция позволяет скрывать потенциально чувствительный контент путем размытия изображения до тех пор, пока пользователь не наведет на него курсор мыши.

## Текущая версия

**1.0.1** - Исправлены критические ошибки

### Изменения в версии 1.0.1:
- ✅ Исправлена проблема с выравниванием изображений - спойлер теперь сохраняет исходное выравнивание блока
- ✅ Исправлена работа размытия изображений - эффект теперь применяется через серверный рендеринг
- ✅ Упрощен JavaScript код - удалены избыточные фильтры
- ✅ Оптимизированы CSS стили для лучшей совместимости с темами

### Версия 1.0.0:
- Первый релиз плагина

## Основные возможности

### 1. Кнопка "Спойлер" в панели инструментов блока
- В панели инструментов (toolbar) блока Image появляется новая кнопка с иконкой глаза
- Кнопка активируется/деактивируется переключением, визуально показывая текущее состояние
- При нажатии кнопки изображение становится спойлером

### 2. Размытие изображения
- Изображение, помеченное как спойлер, отображается размытым (blur: 20px)
- При наведении курсора мыши размытие плавно исчезает (transition: 0.3s ease)
- Эффект работает как на самом изображении, так и на обертке

### 3. Текст предупреждения
- При активации спойлера в правой панели (Inspector Controls) появляется секция "Настройки спойлера"
- В этой секции есть поле "Текст спойлера" для ввода пользовательского текста
- Значение по умолчанию: "Потенциально неприемлемый контент"
- Текст отображается поверх размытого изображения:
  - Белым цветом на полупрозрачном черном фоне
  - По центру изображения
  - С тенью для лучшей читаемости
  - Исчезает при наведении курсора

### 4. Визуальное отображение в редакторе
- В редакторе изображение с включенным спойлером отображается с легким размытием (blur: 5px)
- Добавляется пунктирная граница синего цвета для индикации
- При выделении блока размытие уменьшается для удобства редактирования

## Технические характеристики

### Структура файлов
```
image-spoiler/
├── image-spoiler.php           # Основной файл плагина
├── package.json                # Конфигурация сборки
├── src/                        # Исходные файлы
│   ├── index.js               # Основной JavaScript код
│   ├── style.css              # Стили для фронтенда
│   └── editor.css             # Стили для редактора
├── build/                      # Собранные файлы
│   ├── index.js               # Скомпилированный JavaScript
│   ├── index.css              # Стили редактора
│   ├── style-index.css        # Стили фронтенда
│   └── index.asset.php        # Метаданные зависимостей
└── languages/                  # Файлы локализации
    ├── image-spoiler.pot      # Шаблон переводов
    ├── image-spoiler-ru_RU.po # Русский перевод
    ├── image-spoiler-ru_RU.mo # Скомпилированный русский
    ├── image-spoiler-ru_RU-*.json  # JSON для Gutenberg (русский)
    ├── image-spoiler-en_US.po # Английский перевод
    ├── image-spoiler-en_US.mo # Скомпилированный английский
    └── image-spoiler-en_US-*.json  # JSON для Gutenberg (английский)
```

### Используемые технологии
- **WordPress Gutenberg API**: Расширение стандартных блоков через фильтры
- **React**: Для создания интерфейса в редакторе
- **@wordpress/scripts**: Для сборки и компиляции
- **CSS3**: Для визуальных эффектов (blur, transition)
- **WordPress i18n**: Для локализации

### Хуки и фильтры WordPress

#### PHP фильтры:
1. `render_block` - серверная обработка и модификация вывода блока Image на фронтенде
   - Добавляет класс `image-spoiler` к элементу `<img>`
   - Добавляет класс `has-image-spoiler` к элементу `<figure>` (обертке блока)
   - Вставляет `<div class="image-spoiler-text">` с текстом предупреждения
   - Использует DOMDocument для корректной манипуляции HTML
   - Сохраняет все существующие классы и атрибуты блока (включая выравнивание)

#### Используемые фильтры Gutenberg (JavaScript):
1. `blocks.registerBlockType` - добавление новых атрибутов к блоку Image
2. `editor.BlockEdit` - добавление элементов управления в редактор

#### Добавленные атрибуты:
- `isSpoiler` (boolean) - флаг включения спойлера
- `spoilerText` (string) - текст предупреждения

### Компоненты WordPress
- `BlockControls` - для кнопки в панели инструментов
- `InspectorControls` - для настроек в правой панели
- `ToolbarButton` - кнопка переключения спойлера
- `TextControl` - поле ввода текста предупреждения
- `PanelBody` - секция настроек

## Локализация

Плагин полностью локализован и поддерживает:
- **Русский язык (ru_RU)** - полный перевод интерфейса
- **Английский язык (en_US)** - полный перевод интерфейса

Все строки переведены через WordPress i18n API с использованием функции `__()`.

### Переведенные строки:
1. "Спойлер" / "Spoiler" - метка кнопки
2. "Настройки спойлера" / "Spoiler Settings" - заголовок панели
3. "Текст спойлера" / "Spoiler Text" - метка поля
4. "Потенциально неприемлемый контент" / "Potentially sensitive content" - текст по умолчанию
5. "Текст, который будет отображаться поверх размытого изображения" / "Text that will be displayed over the blurred image" - подсказка

## Стилизация

### Фронтенд
- Размытие: 20px с плавным переходом 0.3s
- Текст спойлера: белый цвет на полупрозрачном черном фоне (rgba(0,0,0,0.7))
- Позиционирование: абсолютное, по центру изображения
- Адаптивность: уменьшенный размер текста на мобильных устройствах
- Поддержка выравнивания: left, right, center

### Редактор
- Легкое размытие (5px) для индикации
- Пунктирная граница синего цвета (#2271b1)
- Уменьшенная непрозрачность (0.8)
- Выделенный блок имеет меньшее размытие (2px)

## Совместимость

- **WordPress**: 5.8 и выше
- **PHP**: 7.4 и выше
- **Gutenberg**: Работает со стандартным блоком Image
- **Темы**: Универсальная совместимость, не зависит от темы

## Использование

1. Добавьте блок "Изображение" в редактор Gutenberg
2. Выберите или загрузите изображение
3. Нажмите кнопку "Спойлер" в панели инструментов блока
4. (Опционально) Измените текст предупреждения в правой панели настроек
5. Опубликуйте или обновите страницу
6. На фронтенде изображение будет размыто до наведения курсора

## Особенности реализации

### Пользовательская иконка
Плагин использует собственную SVG иконку (перечеркнутый глаз) вместо стандартных WordPress иконок для лучшей визуальной идентификации функции спойлера.

### Обертка изображения
При включении спойлера изображение автоматически оборачивается в `<div class="image-spoiler-wrapper">`, что обеспечивает корректное позиционирование текста предупреждения.

### Классы CSS
- `.image-spoiler` - применяется к самому элементу `<img>`
- `.image-spoiler-wrapper` - обертка для изображения с спойлером
- `.image-spoiler-text` - контейнер для текста предупреждения

### Автоматическая установка текста по умолчанию
При активации спойлера автоматически устанавливается текст по умолчанию, если поле пустое. Это обеспечивает лучший пользовательский опыт.

## Безопасность

- Прямой доступ к файлам плагина заблокирован через проверку `ABSPATH`
- Все пользовательские данные проходят через WordPress API
- Нет SQL-запросов или прямой работы с базой данных
- Нет административной панели, что минимизирует поверхность атаки

## Производительность

- Минимальное влияние на производительность
- CSS-эффекты используют GPU-ускорение (filter, transform)
- JavaScript загружается только в редакторе
- На фронтенде только CSS (без JavaScript)
- Сжатые и минифицированные файлы в production

## Будущие улучшения

Возможные направления для развития:
1. Дополнительные стили размытия (pixelate, grayscale)
2. Анимации появления/исчезновения
3. Кнопка явного раскрытия спойлера (click-to-reveal)
4. Настройки степени размытия
5. Поддержка других типов блоков (Gallery, Cover)
6. Опция полного скрытия изображения вместо размытия

## Лицензия

GPL v2 or later

## Автор

**Владимир Бычко**
Сайт: http://bychko.ru

---

*Дата создания: 23 ноября 2024*
*Версия документа: 1.0*