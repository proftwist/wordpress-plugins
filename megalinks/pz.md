# Документация плагина Megalinks

## Описание
Плагин WordPress для добавления всплывающих подсказок с цитатами (excerpt) для внутренних ссылок на посты и страницы. Поддерживает отображение миниатюр постов и работает только на десктопных устройствах. Полностью совместим с произвольными permalink структурами.

## Функциональность

### Основные возможности
- ✅ Всплывающие подсказки при наведении на внутренние ссылки
- ✅ Отображение цитаты из поля excerpt поста
- ✅ Миниатюра поста в tooltip (для постов с изображениями)
- ✅ Адаптивный дизайн: с изображением или только текст (зависит от наличия миниатюры)
- ✅ Только десктопные устройства (ширина > 768px)
- ✅ Умное позиционирование (предпочтительно сверху, снизу только при недостатке места)
- ✅ Кеширование для производительности
- ✅ Поддержка произвольных permalink структур
- ✅ Чёрный дизайн тултипа с тёмной темой

### Фильтрация ссылок
- ✅ Только внутренние ссылки на посты и страницы
- ❌ Исключение ссылок на архивы, теги, категории
- ❌ Исключение ссылок внутри изображений
- ❌ Исключение внешних ссылок
- ❌ Исключение ссылок на системные файлы
- ❌ Исключение якорей на текущей странице (#anchor)
- ❌ Исключение ссылок в навигационных меню WordPress
- ❌ Исключение ссылок внутри заголовков (H1-H6)
- ❌ Исключение ссылок в блоках даты поста (wp-block-post-date)
- ❌ Исключение ссылок в блоках пагинации (wp-block-query-pagination-next/previous, cresta-nav-previous)
- ❌ Исключение ссылок внутри контейнера crestaPostsBoxContent

## Техническая архитектура

### Структура файлов
```
megalinks/
├── megalinks.php          # Основной класс и логика
├── assets/
│   ├── js/megalinks.js    # JavaScript для hover эффектов
│   └── css/megalinks.css  # Стили tooltip
└── README.md             # Публичная документация
```

### Основные компоненты

#### PHP (megalinks.php)
- **Megalinks** - основной класс плагина
- AJAX обработчики для цитат и миниатюр
- Регистрация настроек и админки
- Условная загрузка ресурсов

#### JavaScript (megalinks.js)
- Обработка hover событий
- AJAX запросы к серверу
- Умное позиционирование tooltip
- Кеширование данных

#### CSS (megalinks.css)
- Тёмный дизайн тултипа (#333 фон)
- Адаптивный layout: фиксированная высота контейнера изображения (150px)
- Чёрные окантовки и заглушки
- Поддержка тёмной темы браузера
- Анимации и стрелки позиционирования

## Решение проблем

### 1. Определение ID поста по URL
**Проблема**: В произвольных permalink структурах ID не извлекается из URL.
**Решение**: AJAX эндпоинт `megalinks_get_post_id_by_url` с использованием `url_to_postid()` и `get_page_by_path()`.

### 2. Кеширование миниатюр
**Проблема**: При повторных наведениях миниатюры исчезали.
**Решение**: Добавлен `thumbnailCache` с проверкой полноты кеша (цитата + миниатюра).

### 5. Синхронные AJAX запросы для ID поста
**Проблема**: В произвольных permalink структурах ID поста невозможно извлечь из URL на клиенте.
**Решение**: Синхронный AJAX запрос к эндпоинту `megalinks_get_post_id_by_url` для получения ID по полному URL.

### 6. Динамический контент и делегирование событий
**Проблема**: Ссылки, загружаемые через AJAX, не обрабатывались.
**Решение**: Использование делегирования событий `$(document).on('mouseenter', 'a[href]', ...)` для поддержки динамического контента.

### 3. Позиционирование tooltip
**Проблема**: Tooltip прыгал при повторных наведениях.
**Решение**: Точное измерение высоты с временным элементом + кеширование.

### 4. Админка не появлялась
**Проблема**: Условная регистрация хуков блокировала админку.
**Решение**: Регистрация всех хуков всегда, проверка настроек внутри функций.

## Настройки плагина

### Расположение
**Админка** → **Настройки** → **Megalinks**

### Параметры
- **Включить плагин** (checkbox) - основная настройка включения/выключения

## API

### AJAX эндпоинты
- `megalinks_get_excerpt` - получение цитаты поста по ID
- `megalinks_get_post_id_by_url` - получение ID поста по полному URL (для произвольных permalink)
- `megalinks_get_thumbnail` - получение миниатюры поста по ID

### JavaScript объект
```javascript
megalinksAjax = {
    ajaxurl: '...',
    nonce_excerpt: '...',      // Nonce для получения цитат
    nonce_post_id: '...',      // Nonce для получения ID поста
    nonce_thumbnail: '...'     // Nonce для получения миниатюр
}
```

## Совместимость
- WordPress 5.0+
- PHP 7.0+
- Все современные браузеры

## Безопасность
- Индивидуальные nonce для каждого AJAX эндпоинта
- Строгая валидация входных данных в PHP
- Очистка HTML контента с `wp_strip_all_tags()`
- Защита от XSS и CSRF атак

## Производительность
- Умное кеширование цитат и миниатюр на клиенте
- Предварительная проверка наличия миниатюр перед созданием тултипа
- Адаптивный дизайн: компактные тултипы для постов без изображений
- Отложенная загрузка изображений с `loading="lazy"`
- Оптимизированные селекторы и делегирование событий
- Фиксированные размеры контейнеров для предотвращения прыжков

## Разработка и отладка
- Очищенные логи: удалены избыточные записи error_log
- Улучшенные console логи с правильными уровнями (warn/error)
- Оптимизированные комментарии в коде

## Результат
Плагин полностью функционален и готов к использованию. Реализована адаптивная логика отображения тултипов:

- **Для постов с изображениями**: красивые тултипы с миниатюрой и текстом
- **Для постов без изображений**: компактные тултипы только с текстом

Плагин корректно работает с любыми permalink структурами WordPress, эффективно фильтрует неподходящие ссылки, обеспечивает плавное позиционирование без прыжков и поддерживает высокую производительность благодаря умному кешированию и оптимизациям.