# Пояснительная записка к плагину Smart Glossary Autolinker

## Описание проекта

Плагин Smart Glossary Autolinker представляет собой WordPress плагин, который автоматически находит предопределенные термины в контенте постов и оборачивает их в HTML теги `<abbr>` с определениями в виде подсказок. Это помогает читателям понимать технические термины и жаргон без загромождения контента.

## Основная функциональность

### Автоматическое связывание терминов

**Принцип работы:**
```
Добавляете термин → Плагин находит его в тексте → Оборачивает в <abbr> → Показывает определение при наведении
```

### Умное сопоставление

**Особенности:**
- Пропускает термины внутри HTML ссылок (`<a>` теги)
- Пропускает термины внутри любых HTML тегов
- Регистронезависимый поиск (WordPress = wordpress = WORDPRESS)
- Сортировка по длине для избежания частичных совпадений
- Пример: "WordPress Plugin" заменяется раньше, чем "WordPress"

## Техническая архитектура

### Система компонентов

#### 1. PHP ядро (smart-glossary.php)
- **Инициализация плагина**: Загрузка классов и регистрация хуков
- **Активация**: Создание таблицы БД при активации
- **Локализация**: Загрузка переводов через `load_plugin_textdomain`
- **Стили**: Подключение CSS для визуального оформления

#### 2. Админ-панель (includes/class-sg-admin.php)
- **Меню**: Подпункт в разделе "Настройки" (Settings)
- **Управление терминами**: Добавление, редактирование, просмотр, удаление терминов
- **Настройки**: Включение/выключение функциональности плагина
- **Безопасность**: WordPress nonce защита, санитизация данных

#### 3. Фронтенд логика (includes/class-sg-frontend.php)
- **Фильтр контента**: Обработка `the_content` для поиска терминов
- **Кеширование**: Кеширование терминов из БД для производительности
- **Регулярные выражения**: Умное сопоставление с исключением HTML тегов
- **Сортировка**: Сортировка терминов по длине (от длинных к коротким)

#### 4. Стили (css/style.css)
- **Визуальная подсветка**: Пунктирное подчеркивание и цветной фон
- **Интерактивность**: Эффект при наведении курсора
- **Доступность**: Курсор `help` для указания на наличие подсказки

### База данных

#### Таблица `wp_smart_glossary`
```sql
CREATE TABLE wp_smart_glossary (
    id mediumint(9) NOT NULL AUTO_INCREMENT,
    term varchar(255) NOT NULL,
    definition text NOT NULL,
    PRIMARY KEY (id)
);
```

**Структура:**
- `id` - Уникальный идентификатор термина
- `term` - Термин для поиска (максимум 255 символов)
- `definition` - Определение термина (текстовое поле)

## Ключевые возможности

### Функциональность плагина
- **Автоматическое обнаружение**: Сканирование контента постов на наличие терминов
- **Умное сопоставление**: Пропуск терминов внутри HTML тегов и ссылок
- **Визуальная подсветка**: Пунктирное подчеркивание и цветной фон
- **Подсказки**: Определения терминов при наведении курсора
- **Управление**: Простой интерфейс для добавления, редактирования и удаления терминов
- **Настройки**: Возможность включения/выключения без деактивации

### Безопасность
- **WordPress nonce**: Защита всех форм от CSRF атак
- **Санитизация**: Очистка всех пользовательских данных
- **Экранирование**: Безопасный вывод всех данных
- **Права доступа**: Проверка `manage_options` для админ-функций

### Производительность
- **Кеширование терминов**: Кеширование результатов запроса к БД
- **Оптимизированные запросы**: Один запрос для получения всех терминов
- **Умная сортировка**: Предварительная сортировка для эффективного сопоставления

## Технологический стек

### Backend
- **PHP 7.4+** с современным синтаксисом
- **WordPress Hooks** для интеграции
- **MySQL/MariaDB** для хранения терминов
- **WordPress Database API** для работы с БД

### Frontend
- **CSS3** для визуального оформления
- **HTML5** семантические теги (`<abbr>`)
- **WordPress Enqueue API** для подключения стилей

## Алгоритм работы

### Процесс обработки контента

1. **Получение терминов из БД**
   - Запрос всех терминов из таблицы `wp_smart_glossary`
   - Сортировка по длине строки (от длинных к коротким)
   - Кеширование результатов

2. **Подготовка регулярного выражения**
   - Экранирование спецсимволов в терминах через `preg_quote`
   - Объединение всех терминов через `|` (OR)
   - Создание паттерна для поиска целых слов (`\b...\b`)

3. **Поиск и замена**
   - Регулярное выражение: `/(<a\b[^>]*>.*?<\/a>|<[^>]+>)|(\b(?:Term1|Term2)\b)/uis`
   - Группа 1: HTML теги и ссылки (пропускаются)
   - Группа 2: Найденные термины (заменяются на `<abbr>`)
   - Флаги: `u` (UTF-8), `i` (case-insensitive), `s` (dotall)

4. **Создание abbr тегов**
   - Поиск определения для найденного термина (регистронезависимый)
   - Экранирование определения через `esc_attr`
   - Формирование HTML: `<abbr class="smart-glossary-term" title="определение">термин</abbr>`

## Локализация

### Поддерживаемые языки
- **Русский** (ru_RU) - полная локализация
- **Английский** (en_US) - исходные строки в коде

### Файлы локализации
- `languages/smart-glossary-ru_RU.po` - исходный файл перевода
- `languages/smart-glossary-ru_RU.mo` - скомпилированный файл перевода

### Переведенные строки
- Названия меню и страниц
- Надписи на кнопках и формах
- Сообщения об успехе/ошибках
- Заголовки таблиц и полей

## Процесс развертывания

### Установка
1. Загрузить папку плагина в `/wp-content/plugins/`
2. Активировать через админ-панель WordPress
3. Перейти в Настройки → Smart Glossary
4. Добавить термины и определения

### Использование
1. Добавить термин (например: "WordPress")
2. Добавить определение (например: "Популярная CMS")
3. Создать пост с текстом, содержащим термин
4. На фронтенде термин будет подсвечен, при наведении появится подсказка

## Примеры использования

### Пример 1: Базовое использование
```
Термин: WordPress
Определение: Популярная система управления контентом

Текст поста: "Этот сайт работает на WordPress"
Результат: "Этот сайт работает на <abbr title="Популярная система управления контентом">WordPress</abbr>"
```

### Пример 2: Избежание замены в ссылках
```
Термин: WordPress
Определение: Популярная CMS

Текст поста: "<a href="#">Скачать WordPress</a>"
Результат: "<a href="#">Скачать WordPress</a>" (без изменений)
```

### Пример 3: Сортировка по длине
```
Термины: "WordPress Plugin", "WordPress"

Текст поста: "WordPress Plugin для WordPress"
Результат: "<abbr>WordPress Plugin</abbr> для <abbr>WordPress</abbr>"
(Длинный термин заменяется первым)
```

## История версий

### 1.1.0 (2024) - Добавлено редактирование терминов
- Добавлена возможность редактирования терминов и определений в админ-панели
- Кнопка "Редактировать" в списке терминов
- Форма редактирования с предзаполненными данными
- Обновлена локализация с новыми строками для редактирования

### 1.0.0 (01.10.2023) - Первоначальный релиз
- Автоматическое обнаружение терминов в контенте
- Умное сопоставление с исключением HTML тегов
- Регистронезависимый поиск
- Визуальная подсветка с CSS стилями
- Интерфейс управления в настройках WordPress
- Полная локализация (русский и английский)
- Возможность включения/выключения функциональности
- Сортировка терминов по длине для избежания частичных совпадений

## Совместимость

### Системные требования
- **WordPress**: 5.0+
- **PHP**: 7.4+
- **MySQL**: 5.6+

### Поддерживаемые браузеры
- Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

## API для разработчиков

### CSS классы для кастомизации
```css
.smart-glossary-term     /* Основной класс для abbr тегов */
```

### WordPress хуки
```php
// Фильтр для изменения контента перед обработкой
add_filter('the_content', function($content) {
    // Кастомная обработка контента
    return $content;
}, 10);

// Фильтр для изменения списка терминов
add_filter('sg_get_terms', function($terms) {
    // Модификация списка терминов
    return $terms;
}, 10);
```

### Прямой доступ к классам
```php
// Получение экземпляра фронтенд класса
$frontend = new SG_Frontend();

// Получение терминов
$terms = $frontend->get_terms(); // Через рефлексию или публичный метод
```

## Поддержка

### Техническая информация
- **Автор**: Владимир Бычко (http://bychko.ru)
- **Лицензия**: GPL v2 или более поздняя
- **Текущая версия**: 1.0.0
- **Дата последнего обновления**: 01.10.2023

### Документация
- Подробные инструкции в README.txt
- Примеры использования в pz.md
- API документация для разработчиков

---

**Плагин разработан с соблюдением стандартов WordPress Codex, лучших практик безопасности и современных принципов разработки.**
