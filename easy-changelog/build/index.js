(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var n in t)e.o(t,n)&&!e.o(a,n)&&Object.defineProperty(a,n,{enumerable:!0,get:t[n]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.wp.blocks,t=window.wp.i18n,n=window.React,l=window.wp.element,o=window.wp.blockEditor,s=window.wp.components,r=window.wp.apiFetch;var c=e.n(r);const g=window.easyChangelogI18n||{};(0,a.registerBlockType)("easy-changelog/changelog",{title:window.easyChangelogI18n?.title||(0,t.__)("Easy Changelog","easy-changelog"),description:window.easyChangelogI18n?.description||(0,t.__)("Блок для отображения changelog с автоматической синхронизацией из GitHub","easy-changelog"),category:"easy-changelog",icon:"list-view",supports:{html:!1},attributes:{changelogData:{type:"string",default:'[\n  {\n    "version": "1.0.0",\n    "date": "19.11.2025",\n    "added": ["Первоначальный релиз плагина", "Базовая функциональность блоков"],\n    "fixed": ["Исправлена ошибка валидации JSON", "Улучшена обработка дат"]\n  },\n  {\n    "version": "0.9.0",\n    "date": "15.11.2025",\n    "added": ["Бета-версия плагина", "Тестирование функциональности"],\n    "fixed": ["Устранены проблемы с локализацией"]\n  }\n]'},jsonUrl:{type:"string",default:""},useExternalUrl:{type:"boolean",default:!1},blockId:{type:"string",default:""}},edit:({attributes:e,setAttributes:a,clientId:r})=>{const{changelogData:i,jsonUrl:d,useExternalUrl:h,blockId:m}=e,[y,u]=(0,l.useState)([]),[p,b]=(0,l.useState)(""),[_,E]=(0,l.useState)(""),[w,f]=(0,l.useState)(""),[v,x]=(0,l.useState)(""),[k,S]=(0,l.useState)(!1);(0,l.useEffect)(()=>{m||a({blockId:r})},[m,r,a]),(0,l.useEffect)(()=>{h&&d&&c()({path:"/easy-changelog/v1/webhook-url"}).then(e=>{x(e.url)}).catch(e=>{console.error("Failed to get webhook URL:",e)})},[h,d]),(0,l.useEffect)(()=>{try{const e=JSON.parse(i);Array.isArray(e)?(u(e),b("")):b(g.mustBeArray||(0,t.__)("Данные должны быть массивом","easy-changelog"))}catch(e){b(g.invalidJson||(0,t.__)("Некорректный JSON формат","easy-changelog"))}},[i]);const N=[{name:"editor",title:g.jsonEditor||(0,t.__)("Редактор JSON","easy-changelog")},{name:"external",title:g.externalJson||(0,t.__)("Внешний JSON","easy-changelog")},{name:"preview",title:g.preview||(0,t.__)("Предпросмотр","easy-changelog")}],U=async()=>{if(!d)return E("error"),void f((0,t.__)("Введите URL для загрузки","easy-changelog"));E("loading"),f("");try{const e=await c()({path:"/easy-changelog/v1/fetch-external",method:"POST",data:{url:d}});if(e.success&&e.data){a({changelogData:JSON.stringify(e.data,null,2),useExternalUrl:!0}),E("success"),f(g.fetchSuccess||(0,t.__)("Данные успешно загружены","easy-changelog"));const n=await c()({path:"/easy-changelog/v1/webhook-url"});x(n.url)}else E("error"),f(e.message||g.fetchError||(0,t.__)("Ошибка загрузки внешнего JSON","easy-changelog"))}catch(e){E("error"),f(e.message||g.fetchError||(0,t.__)("Ошибка загрузки внешнего JSON","easy-changelog"))}},O=()=>{navigator.clipboard.writeText(v).then(()=>{S(!0),setTimeout(()=>S(!1),2e3)})},J=(e,a="added")=>Array.isArray(e)&&0!==e.length?(0,n.createElement)("ul",{className:`easy-changelog-${a}`},e.map((e,t)=>(0,n.createElement)("li",{key:t,className:`easy-changelog-item easy-changelog-item-${a}`},e))):null;return(0,n.createElement)("div",{...(0,o.useBlockProps)()},(0,n.createElement)(s.TabPanel,{className:"easy-changelog-tabs",tabs:N},e=>(0,n.createElement)("div",{className:"easy-changelog-tab-content"},"editor"===e.name&&(0,n.createElement)("div",null,(0,n.createElement)(s.TextareaControl,{label:g.changelogData||(0,t.__)("Данные Changelog (JSON)","easy-changelog"),value:i,onChange:e=>a({changelogData:e,useExternalUrl:!1}),rows:15,help:g.jsonHelp||(0,t.__)("Введите данные в формате JSON. Каждый релиз должен содержать version, date, added и fixed.","easy-changelog")}),p&&(0,n.createElement)("div",{style:{color:"#cc1818",marginTop:"10px"}},g.error||(0,t.__)("Ошибка:","easy-changelog")," ",p)),"external"===e.name&&(0,n.createElement)("div",null,(0,n.createElement)(s.ToggleControl,{label:g.useExternalUrl||(0,t.__)("Использовать внешний JSON","easy-changelog"),checked:h,onChange:e=>a({useExternalUrl:e})}),h&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)(s.TextControl,{label:g.jsonUrl||(0,t.__)("URL внешнего JSON файла","easy-changelog"),value:d,onChange:e=>a({jsonUrl:e}),help:g.urlHelp||(0,t.__)("Укажите прямую ссылку на JSON файл в GitHub или другом хранилище","easy-changelog")}),(0,n.createElement)("div",{style:{margin:"15px 0"}},(0,n.createElement)(s.Button,{variant:"primary",onClick:U,isBusy:"loading"===_,disabled:!d||"loading"===_},g.loadFromUrl||(0,t.__)("Загрузить из URL","easy-changelog"))),"success"===_&&(0,n.createElement)(s.Notice,{status:"success",isDismissible:!1},w),"error"===_&&(0,n.createElement)(s.Notice,{status:"error",isDismissible:!1},w),v&&(0,n.createElement)("div",{style:{background:"#f0f9ff",border:"1px solid #bae6fd",borderRadius:"4px",marginTop:"15px",padding:"15px"}},(0,n.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}},(0,n.createElement)("strong",{style:{color:"#0369a1"}},g.autoSyncEnabled||(0,t.__)("Автосинхронизация включена","easy-changelog")," ✅"),(0,n.createElement)(s.Button,{variant:"secondary",onClick:O,style:{height:"32px"}},g.copyWebhookUrl||(0,t.__)("Скопировать Webhook URL","easy-changelog"))),k&&(0,n.createElement)(s.Notice,{status:"success",isDismissible:!1},g.webhookCopied||(0,t.__)("Webhook URL скопирован в буфер обмена","easy-changelog")),(0,n.createElement)("div",{style:{fontSize:"13px",color:"#475569",marginBottom:"10px"}},g.webhookHelp||(0,t.__)("Добавьте этот URL как webhook в настройках вашего GitHub репозитория для автоматического обновления","easy-changelog"),":"),(0,n.createElement)("div",{style:{background:"#fff",padding:"8px",borderRadius:"3px",border:"1px solid #e2e8f0",fontSize:"12px",fontFamily:"monospace",wordBreak:"break-all"}},v),(0,n.createElement)("div",{style:{fontSize:"12px",color:"#64748b",marginTop:"8px"}},g.webhookInstructions||(0,t.__)('Для автоматического обновления: Settings → Webhooks → Add webhook → Payload URL → выберите "Just the push event"',"easy-changelog"))),(0,n.createElement)("div",{style:{background:"#f6f7f7",padding:"15px",borderRadius:"4px",marginTop:"15px",fontSize:"13px"}},(0,n.createElement)("strong",null,g.githubHelp||(0,t.__)("Как получить ссылку на GitHub:","easy-changelog")),(0,n.createElement)("p",{style:{margin:"8px 0"}},g.githubInstructions||(0,t.__)('1. Перейдите в репозиторий на GitHub → 2. Выберите ветку → 3. Найдите файл → 4. Нажмите "Raw" → 5. Скопируйте URL из адресной строки',"easy-changelog")),(0,n.createElement)("p",{style:{margin:"8px 0",fontFamily:"monospace",background:"#fff",padding:"5px",borderRadius:"3px"}},g.exampleUrl||(0,t.__)("Пример: https://raw.githubusercontent.com/username/repo/main/changelog.json","easy-changelog"))))),"preview"===e.name&&(0,n.createElement)("div",{className:"easy-changelog-block easy-changelog-preview"},p?(0,n.createElement)("div",{style:{color:"#cc1818"}},g.cannotPreview||(0,t.__)("Невозможно отобразить предпросмотр из-за ошибок в JSON","easy-changelog")):(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h2",{className:"easy-changelog-title"},g.changelogTitle||(0,t.__)("История изменений","easy-changelog")),y.map((e,a)=>(0,n.createElement)("div",{key:a,className:"easy-changelog-release"},(0,n.createElement)("div",{className:"easy-changelog-version"},(0,n.createElement)("strong",null,e.version)),(0,n.createElement)("div",{className:"easy-changelog-date"},e.date),(0,n.createElement)("div",{className:"easy-changelog-content"},J(e.added,"added"),J(e.fixed,"fixed")))))))))},save:()=>null})})();